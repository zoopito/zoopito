<% layout("layouts/boilerplate") %>

<div class="container mx-auto p-4 md:p-6">
  <h1 class="text-2xl md:text-3xl font-bold mb-4 md:mb-6 text-blue-700 dark:text-blue-400">
    <%= formType === 'bulk' ? 'Register Multiple Animals' : 'Register New Animal' %>
  </h1>

  <% if (formType === 'bulk') { %>
  <div class="mb-6 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700 rounded-lg p-4">
    <div class="flex items-start">
      <svg class="w-6 h-6 text-blue-600 dark:text-blue-400 mt-1 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
      </svg>
      <div>
        <h3 class="font-semibold text-blue-800 dark:text-blue-300">Bulk Registration Mode</h3>
        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
          Fill common details once and register multiple animals with the same farmer, registration agent.
          Use the "Add Another Animal" button to add more entries.
        </p>
      </div>
    </div>
  </div>
  <% } %>

  <form action="/<%= currUser && currUser.role ? currUser.role.toLowerCase() : '' %>/animals<%= formType === 'bulk' ? '/bulk' : '' %>" 
        method="POST" 
        enctype="multipart/form-data" 
        class="space-y-6 bg-white dark:bg-gray-800 p-4 md:p-6 rounded-lg shadow-md transition-colors duration-300">
    
    <!-- Common Information Section (For All Animals) -->
    <div class="border-b pb-6 mb-6 border-gray-200 dark:border-gray-700">
      <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-200 flex items-center">
        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
        </svg>
        Common Information (For All Animals)
      </h2>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
        <!-- Farmer -->
        <div>
          <label for="farmer" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Farmer *</label>
          <select name="farmer" id="farmer" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition">
            <option value="">Select Farmer</option>
            <% farmers.forEach(farmer => { %>
              <option value="<%= farmer._id %>" <%= formData && formData.farmer === farmer._id.toString() ? 'selected' : '' %>>
                <%= farmer.uniqueFarmerId %>: <%= farmer.name %>
              </option>
            <% }) %>
          </select>
        </div>

        <!-- Registered By -->
        <div>
          <label for="registeredBy" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Registered By *</label>
          <select name="registeredBy" id="registeredBy" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition">
            <option value="">Select Sales Agent</option>
            <% sales.forEach(sale => { %>
              <option value="<%= sale._id %>" <%= formData && formData.registeredBy === sale._id.toString() ? 'selected' : '' %>>
                <%= sale.name %>
              </option>
            <% }) %>
          </select>
        </div>
      </div>
    </div>

    <!-- Animal Entry Sections -->
    <div id="animalEntries">
      <!-- First Animal Entry -->
      <div class="animal-entry border-b pb-6 mb-6 border-gray-200 dark:border-gray-700">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200 flex items-center">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
              <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>
            </svg>
            Animal 1 Details
          </h2>
        </div>
        
        <!-- Basic Information -->
        <div class="mb-6">
          <h3 class="text-lg font-medium mb-4 text-gray-700 dark:text-gray-300">Basic Information</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
            <!-- Animal Type -->
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Animal Type *</label>
              <select name="animals[0][animalType]" required class="animal-type-select w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition">
                <option value="">Select Type</option>
                <option value="Cow">Cow</option>
                <option value="Buffalo">Buffalo</option>
                <option value="Goat">Goat</option>
                <option value="Sheep">Sheep</option>
                <option value="Dog">Dog</option>
                <option value="Cat">Cat</option>
                <option value="Poultry">Poultry</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <!-- Breed -->
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Breed</label>
              <input type="text" name="animals[0][breed]" placeholder="Enter breed" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition">
            </div>

            <!-- Age -->
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Age</label>
                <input type="number" name="animals[0][age][value]" min="0" placeholder="Value" class="age-value-input w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Unit</label>
                <select name="animals[0][age][unit]" class="age-unit-select w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition">
                  <option value="Days">Days</option>
                  <option value="Months">Months</option>
                  <option value="Years" selected>Years</option>
                </select>
              </div>
            </div>

            <!-- Gender -->
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Gender *</label>
              <select name="animals[0][gender]" required class="gender-select w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition">
                <option value="">Select Gender</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Unknown">Unknown</option>
              </select>
            </div>

            <!-- Name -->
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Name</label>
              <input type="text" name="animals[0][name]" placeholder="Enter animal name" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition">
            </div>

            <!-- Is Tagged -->
            <div class="flex gap-2 mt-6">
              <div class="flex items-center">
                <input type="checkbox" name="animals[0][isTagged]" id="isTagged-0" class="h-4 w-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                <label for="isTagged-0" class="  flex ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">Has Tagged</label>
              </div>

              <!-- Tag Number -->
              <div class="flex hidden items-center" id="tagNumberContainer-0">
                <label class="flex text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tag Number</label>
                <input id="tagNumber-0" type="text" name="animals[0][tagNumber]" required placeholder="Enter tag number" class=" px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition">
              </div>
            </div>


            <!-- Date of Birth -->
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Date of Birth</label>
              <input type="date" name="animals[0][dateOfBirth]" class="date-of-birth w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition">
            </div>

            <!-- Health Status -->
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Health Status *</label>
              <select name="animals[0][healthStatus]" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition">
                <option value="">Select Status</option>
                <option value="Healthy">Healthy</option>
                <option value="Sick">Sick</option>
                <option value="Under Treatment">Under Treatment</option>
                <option value="Recovered">Recovered</option>
                <option value="Quarantined">Quarantined</option>
                <option value="Chronic Condition">Chronic Condition</option>
              </select>
            </div>

            <!-- Body Condition Score -->
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Body Condition Score (1-5)</label>
              <select name="animals[0][bodyConditionScore]" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition">
                <option value="3">3 (Ideal)</option>
                <option value="1">1 (Poor)</option>
                <option value="2">2 (Thin)</option>
                <option value="4">4 (Fleshy)</option>
                <option value="5">5 (Obese)</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Pregnancy Status Section - Only shows for Adult Female Animals -->
        <div id="pregnancySection-0" class="pregnancy-section hidden mb-6 border-t pt-6 border-gray-200 dark:border-gray-700">
          <div class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg mb-4">
            <div class="flex items-start">
              <svg class="w-5 h-5 text-purple-600 dark:text-purple-400 mt-0.5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
              </svg>
              <p class="text-sm text-purple-700 dark:text-purple-300">
                <span class="font-medium">Adult Female Animal:</span> Pregnancy information can be recorded below.
              </p>
            </div>
          </div>

          <h3 class="text-lg font-medium mb-4 text-gray-700 dark:text-gray-300 flex items-center">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd"/>
            </svg>
            Pregnancy Status (Manual Entry)
          </h3>
          
          <div class="space-y-4">
            <!-- Pregnancy Check -->
            <div class="flex items-center mb-4">
              <input type="checkbox" name="animals[0][pregnancyStatus][isPregnant]" id="isPregnant-0" class="pregnancy-checkbox h-4 w-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
              <label for="isPregnant-0" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">Is Pregnant</label>
            </div>

            <!-- Pregnancy Details -->
            <div id="pregnancyDetails-0" class="pregnancy-details hidden space-y-4 bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg">
              <!-- Test Date -->
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Test Date</label>
                <input type="date" name="animals[0][pregnancyStatus][testDate]" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition">
              </div>

              <!-- Confirmation Date -->
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Confirmed Date</label>
                <input type="date" name="animals[0][pregnancyStatus][confirmedDate]" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition">
              </div>

              <!-- Expected Delivery Date -->
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Expected Delivery Date</label>
                <input type="date" name="animals[0][pregnancyStatus][expectedDeliveryDate]" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition">
              </div>

              <!-- Pregnancy Stage -->
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Pregnancy Stage</label>
                <select name="animals[0][pregnancyStatus][stage]" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition">
                  <option value="">Select Stage</option>
                  <option value="early">Early (0-3 months)</option>
                  <option value="mid">Mid (3-6 months)</option>
                  <option value="late">Late (6-9 months)</option>
                  <option value="full_term">Full Term</option>
                </select>
              </div>

              <!-- Number of Fetuses -->
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Number of Fetuses</label>
                <input type="number" name="animals[0][pregnancyStatus][numberOfFetuses]" min="1" max="10" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition">
              </div>

              <!-- Previous Pregnancies -->
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Previous Pregnancies</label>
                <input type="number" name="animals[0][pregnancyStatus][previousPregnancies]" min="0" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition">
              </div>

              <!-- Notes -->
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Pregnancy Notes</label>
                <textarea name="animals[0][pregnancyStatus][notes]" rows="2" placeholder="Any additional notes about pregnancy..." class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition"></textarea>
              </div>
            </div>
          </div>
        </div>

        <!-- Photos Section -->
        <div class="mb-6 border-t pt-6 border-gray-200 dark:border-gray-700">
          <h3 class="text-lg font-medium mb-4 text-gray-700 dark:text-gray-300 flex items-center">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
            </svg>
            Animal Photos
          </h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Front Photo</label>
              <input type="file" name="animals[0][photos][front]" accept="image/*" class="w-full text-sm text-gray-600 dark:text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200 dark:file:bg-blue-900 dark:file:text-blue-300 transition">
            </div>
            <!-- <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Left Side Photo</label>
              <input type="file" name="animals[0][photos][left]" accept="image/*" class="w-full text-sm text-gray-600 dark:text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200 dark:file:bg-blue-900 dark:file:text-blue-300 transition">
            </div> -->
            <!-- <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Right Side Photo</label>
              <input type="file" name="animals[0][photos][right]" accept="image/*" class="w-full text-sm text-gray-600 dark:text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200 dark:file:bg-blue-900 dark:file:text-blue-300 transition">
            </div> -->
            <!-- <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Back Photo</label>
              <input type="file" name="animals[0][photos][back]" accept="image/*" class="w-full text-sm text-gray-600 dark:text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200 dark:file:bg-blue-900 dark:file:text-blue-300 transition">
            </div> -->
          </div>
        </div>

        <!-- Vaccination Records Section - PER ANIMAL -->
        <div class="mb-6 border-t pt-6 border-gray-200 dark:border-gray-700">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300 flex items-center">
              <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"/>
              </svg>
              Vaccination Records for Animal 1
            </h3>
            
            <!-- Common for All Animals Checkbox -->
            <!-- <div class="flex items-center">
              <input type="checkbox" 
                     id="commonVaccination-0" 
                     class="common-vaccination-checkbox h-4 w-4 text-green-600 rounded border-gray-300 focus:ring-green-500 dark:bg-gray-700 dark:border-gray-600"
                     data-animal-index="0">
              <label for="commonVaccination-0" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                Common for All Animals
              </label>
            </div> -->
          </div>
          
          <div class="space-y-6">
            <div class="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-lg">
              <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                Select vaccines administered to this specific animal. If "Common for All Animals" is checked, 
                this vaccination record will be applied to all animals in this batch.
              </p>
              
              <% if (vaccines && vaccines.length > 0) { %>
                <div class="space-y-4" id="vaccinesContainer-0">
                  <% vaccines.forEach((vaccine, index) => { %>
                    <div class="vaccine-item border border-gray-200 dark:border-gray-700 rounded-lg p-4 bg-white dark:bg-gray-800">
                      <!-- Vaccine Header with Checkbox -->
                      <div class="flex items-start mb-4">
                        <input type="checkbox" 
                               name="animals[0][vaccinations][<%= vaccine._id %>][administered]" 
                               id="vaccine_0_<%= vaccine._id %>" 
                               value="true"
                               class="animal-vaccine-checkbox h-4 w-4 mt-1 text-blue-600 rounded border-gray-300 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600"
                               data-vaccine-id="<%= vaccine._id %>"
                               data-animal-index="0">
                        <div class="ml-3 flex-1">
                          <label for="vaccine_0_<%= vaccine._id %>" class="block text-sm font-medium text-gray-700 dark:text-gray-300 cursor-pointer">
                            <span class="font-semibold"><%= vaccine.vaccineName || vaccine.name %></span>
                            <% if (vaccine.vaccineType) { %>
                              <span class="text-sm text-gray-500 dark:text-gray-400 ml-2">(<%= vaccine.vaccineType %>)</span>
                            <% } %>
                          </label>
                          <% if (vaccine.diseaseTarget) { %>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Target: <%= vaccine.diseaseTarget %></p>
                          <% } %>
                          <% if (vaccine.manufacturer) { %>
                            <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">Manufacturer: <%= vaccine.manufacturer %></p>
                          <% } %>
                          <% if (vaccine.recommendedSchedule) { %>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Schedule: <%= vaccine.recommendedSchedule %></p>
                          <% } %>
                        </div>
                      </div>
                      
                      <!-- Vaccine Details (Hidden by default) -->
                      <div id="vaccineDetails_0_<%= vaccine._id %>" class="vaccine-details hidden space-y-4 mt-4 pt-4 border-t border-gray-100 dark:border-gray-700">
                        <!-- Store vaccine metadata -->
                        <input type="hidden" name="animals[0][vaccinations][<%= vaccine._id %>][vaccineId]" value="<%= vaccine._id %>">
                        <input type="hidden" name="animals[0][vaccinations][<%= vaccine._id %>][vaccineName]" value="<%= vaccine.vaccineName || vaccine.name %>">
                        <input type="hidden" name="animals[0][vaccinations][<%= vaccine._id %>][vaccineType]" value="<%= vaccine.vaccineType || '' %>">
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <!-- Vaccination Date -->
    <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Vaccination Date * <span class="text-xs text-gray-500">(Date administered)</span>
        </label>
        <input type="date" 
               name="animals[0][vaccinations][<%= vaccine._id %>][dateAdministered]" 
               class="vaccination-date w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition"
               max="<%= new Date().toISOString().split('T')[0] %>"
               data-booster-weeks="<%= vaccine.boosterIntervalWeeks || 0 %>"
               data-vaccine-id="<%= vaccine._id %>"
               data-animal-index="0"
               onchange="calculateNextDueDate(this)">
    </div>
    
    <!-- Administered By -->
    <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Administered By *
        </label>
        <input type="text" 
               name="animals[0][vaccinations][<%= vaccine._id %>][administeredBy]" 
               placeholder="Name of vet/paravet"
               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition">
    </div>
    
    <!-- Next Due Date -->
    <div class="md:col-span-2">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Next Due Date <span class="text-xs text-gray-500">(When next dose is due)</span>
        </label>
        <div class="flex items-center space-x-2">
            <input type="date" 
                   name="animals[0][vaccinations][<%= vaccine._id %>][nextDueDate]" 
                   id="nextDueDate_0_<%= vaccine._id %>"
                   class="next-due-date flex-1 w-full lg:w-1/2 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition">
            
            <!-- Auto-calculate button (optional) -->
            <button type="button" 
                    onclick="autoCalculateNextDue(this)"
                    class="px-3 py-2 bg-blue-100 hover:bg-blue-200 text-blue-700 dark:bg-blue-900 dark:hover:bg-blue-800 dark:text-blue-300 rounded-lg text-sm transition"
                    title="Auto-calculate based on vaccination date">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
            </button>
        </div>
        <% if (vaccine.boosterIntervalWeeks) { %>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                <span class="inline-flex items-center">
                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                    </svg>
                    Booster due after <%= vaccine.boosterIntervalWeeks %> week<%= vaccine.boosterIntervalWeeks > 1 ? 's' : '' %>
                </span>
            </p>
        <% } %>
    </div>
</div>



<!-- For bulk mode with dynamic animals, add this function to reinitialize event listeners -->
<script>
// Call this after adding a new animal entry
function reinitializeVaccineDateListeners(container) {
    container.querySelectorAll('.vaccination-date').forEach(input => {
        // Remove existing listeners to prevent duplicates (optional)
        input.removeEventListener('change', calculateNextDueDate);
        
        // Add new listener
        input.addEventListener('change', function() {
            calculateNextDueDate(this);
        });
    });
}

// If you have a function that adds new animal entries, call reinitializeVaccineDateListeners
// after adding the new HTML
</script>
                          
                          <!-- Batch Number -->
                          <!-- <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                              Batch/Lot Number
                            </label>
                            <input type="text" 
                                   name="animals[0][vaccinations][<%= vaccine._id %>][batchNumber]" 
                                   placeholder="Enter batch number"
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition">
                          </div>
                        </div> -->
                        
                        <!-- Notes -->
                        <div>
                          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Notes
                          </label>
                          <textarea name="animals[0][vaccinations][<%= vaccine._id %>][notes]" 
                                    rows="2" 
                                    placeholder="Any additional notes about this vaccination (e.g., reaction, location)"
                                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition"></textarea>
                        </div>
                      </div>
                    </div>
                  <% }); %>
                </div>
              <% } else { %>
                <div class="text-center py-8">
                  <svg class="w-12 h-12 text-gray-400 dark:text-gray-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                  <p class="text-gray-500 dark:text-gray-400">No vaccines found in database.</p>
                  <p class="text-sm text-gray-400 dark:text-gray-500 mt-1">Please add vaccines first to record vaccinations.</p>
                </div>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Another Animal Button (Only in Bulk Mode) -->
    <% if (formType === 'bulk') { %>
    <div class="mb-6">
      <button type="button" id="addAnimalBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 dark:bg-green-700 dark:hover:bg-green-600 flex items-center justify-center">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
        </svg>
        Add Another Animal
      </button>
      <p class="text-sm text-gray-500 dark:text-gray-400 mt-2 text-center">
        Current count: <span id="animalCount">1</span> animal(s) (Max: 20)
      </p>
    </div>
    <% } %>

    <!-- Common Vaccination Date for All Animals -->
    <div class="border-b pb-6 mb-6 border-gray-200 dark:border-gray-700">
      <div class="flex items-start bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
        <div class="flex items-center h-5">
          <input type="checkbox" 
                 id="applyCommonVaccinationDate" 
                 name="applyCommonVaccinationDate" 
                 class="h-4 w-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
        </div>
        <div class="ml-3 flex-1">
          <label for="applyCommonVaccinationDate" class="text-sm font-medium text-gray-700 dark:text-gray-300 cursor-pointer">
            Add a Vaccination date for remaining vaccines for all animals in this batch (if applicable)
          </label>
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
            Dont click if all animals are vaccined on all available vaccines. Only click if you want to add a common vaccination date for all remaining vaccines that are not marked as administered for each animal. This will help you quickly set the same vaccination date for all those vaccines across all animals.
          </p>
        </div>
      </div>
      
      <!-- <div id="commonVaccinationDateSection" class="hidden mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Common Vaccination Date *
          </label>
          <input type="date" 
                 id="commonVaccinationDate" 
                 name="commonVaccinationDate" 
                 class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition"
                 max="<%= new Date().toISOString().split('T')[0] %>">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Common Next Due Date
          </label>
          <input type="date" 
                 id="commonNextDueDate" 
                 name="commonNextDueDate" 
                 class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition">
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Common Administered By
          </label>
          <input type="text" 
                 id="commonAdministeredBy" 
                 name="commonAdministeredBy" 
                 placeholder="Name of person who administered the vaccine"
                 class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition">
        </div>
      </div> -->
    </div>

    <!-- Other Common Information -->
    <div class="border-b pb-6 mb-6 border-gray-200 dark:border-gray-700">
      <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-200 flex items-center">
        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
        </svg>
        Other Common Information
      </h2>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
        <!-- Reproductive Status -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Reproductive Status</label>
          <select name="reproductiveStatus" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition">
            <option value="normal">Normal</option>
            <option value="in_heat">In Heat</option>
            <option value="bred">Bred</option>
            <option value="open">Open (Not Bred)</option>
            <option value="sterile">Sterile</option>
            <option value="castrated">Castrated</option>
          </select>
        </div>

        <!-- Feeding Type -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Feeding Type</label>
          <select name="feedingType" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition">
            <option value="">Select Type</option>
            <option value="grazing">Grazing</option>
            <option value="stall_feeding">Stall Feeding</option>
            <option value="mixed">Mixed</option>
            <option value="concentrate">Concentrate Based</option>
            <option value="organic">Organic</option>
          </select>
        </div>

        <!-- Housing Type -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Housing Type</label>
          <select name="housingType" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition">
            <option value="">Select Type</option>
            <option value="free_stall">Free Stall</option>
            <option value="tie_stall">Tie Stall</option>
            <option value="pasture">Pasture</option>
            <option value="shelter">Shelter</option>
            <option value="open_yard">Open Yard</option>
            <option value="other">Other</option>
          </select>
        </div>

        <!-- Source of Animal -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Source of Animal</label>
          <select name="sourceOfAnimal" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition">
            <option value="born_on_farm">Born on Farm</option>
            <option value="purchased">Purchased</option>
            <option value="gifted">Gifted</option>
            <option value="transferred">Transferred</option>
            <option value="other">Other</option>
          </select>
        </div>
      </div>

      <!-- Additional Notes -->
      <div class="mt-6">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Additional Notes</label>
        <textarea name="additionalNotes" rows="3" placeholder="Any additional information about these animals..." class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition"></textarea>
      </div>
    </div>

    <!-- Submit Button -->
    <div class="pt-4">
      <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 dark:bg-blue-700 dark:hover:bg-blue-600">
        <%= formType === 'bulk' ? 'Register All Animals' : 'Register Animal' %>
      </button>
    </div>
  </form>
</div>

<script>
  // ================ GLOBAL VARIABLES ================
  let animalCount = 1;
  const maxAnimals = 20;
  let commonVaccinationEnabled = false;

  // ================ DOM CONTENT LOADED ================
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize first animal entry
    initializeAnimalEntry(document.querySelector('.animal-entry'), 0);
    
    // Initialize vaccine checkboxes for first animal
    initializeVaccineCheckboxes(0);
    
    // Initialize is tagged checkbox for first animal
    initializeIsTaggedCheckbox(0);
    
    // Initialize vaccination date listeners for first animal
    initializeVaccinationDateListeners(document.querySelector('.animal-entry'));
    
    // Initialize common vaccination date toggle
    initializeCommonVaccinationDate();
    
    // Initialize common for all animals checkboxes
    initializeCommonForAllCheckboxes();
    
    // Initialize date of birth calculation
    initializeDateOfBirthCalculation();
    
    // Initialize form validation
    initializeFormValidation();
    
    // Update animal count display
    updateAnimalCount();
  });

  // ================ IS TAGGED CHECKBOX INITIALIZATION ================
  
  function initializeIsTaggedCheckbox(index) {
    const isTaggedCheckbox = document.getElementById(`isTagged-${index}`);
    const tagNumberInput = document.getElementById(`tagNumber-${index}`);
    const tagNumberContainer = document.getElementById(`tagNumberContainer-${index}`);

    if (isTaggedCheckbox && tagNumberInput && tagNumberContainer) {
      isTaggedCheckbox.addEventListener('change', function () {
        if (this.checked) {
          tagNumberContainer.classList.remove('hidden');
          tagNumberInput.required = true;
        } else {
          tagNumberContainer.classList.add('hidden');
          tagNumberInput.required = false;
          tagNumberInput.value = "";
        }
      });
    }
  }

  // ================ VACCINATION DATE LISTENERS INITIALIZATION ================
  
  function initializeVaccinationDateListeners(container) {
    container.querySelectorAll('.vaccination-date').forEach(input => {
      input.addEventListener('change', function() {
        calculateNextDueDate(this);
      });
    });
  }

  // ================ ANIMAL ENTRY FUNCTIONS ================
  
  function initializeAnimalEntry(entry, index) {
    const animalTypeSelect = entry.querySelector('.animal-type-select');
    const ageValueInput = entry.querySelector('.age-value-input');
    const ageUnitSelect = entry.querySelector('.age-unit-select');
    const genderSelect = entry.querySelector('.gender-select');
    const dateOfBirthInput = entry.querySelector('.date-of-birth');
    const pregnancySection = document.getElementById(`pregnancySection-${index}`);
    const pregnancyCheckbox = document.getElementById(`isPregnant-${index}`);
    const pregnancyDetails = document.getElementById(`pregnancyDetails-${index}`);

    if (!pregnancySection) return;

    function calculateAgeFromDOB() {
      if (!dateOfBirthInput || !dateOfBirthInput.value) return;
      
      const dob = new Date(dateOfBirthInput.value);
      const today = new Date();
      
      let years = today.getFullYear() - dob.getFullYear();
      let months = today.getMonth() - dob.getMonth();
      let days = today.getDate() - dob.getDate();
      
      if (days < 0) {
        months--;
        days += new Date(today.getFullYear(), today.getMonth(), 0).getDate();
      }
      
      if (months < 0) {
        years--;
        months += 12;
      }
      
      if (years >= 1) {
        ageValueInput.value = years;
        ageUnitSelect.value = 'Years';
      } else if (months >= 1) {
        ageValueInput.value = months;
        ageUnitSelect.value = 'Months';
      } else {
        ageValueInput.value = days;
        ageUnitSelect.value = 'Days';
      }
      
      updatePregnancySection();
    }

    function isAdultAnimal() {
      const ageValue = parseFloat(ageValueInput?.value) || 0;
      const ageUnit = ageUnitSelect?.value;
      const animalType = animalTypeSelect?.value;
      const gender = genderSelect?.value;

      if (!ageValue || !ageUnit || !animalType || gender !== 'Female') {
        return false;
      }

      let ageInMonths = 0;
      if (ageUnit === 'Years') {
        ageInMonths = ageValue * 12;
      } else if (ageUnit === 'Months') {
        ageInMonths = ageValue;
      } else if (ageUnit === 'Days') {
        ageInMonths = ageValue / 30.44;
      }

      const adultThresholds = {
        'Cow': 18,
        'Buffalo': 24,
        'Goat': 8,
        'Sheep': 8,
        'Dog': 12,
        'Cat': 8,
        'Poultry': 5,
        'Other': 12
      };

      const threshold = adultThresholds[animalType] || 12;
      return ageInMonths >= threshold;
    }

    function updatePregnancySection() {
      if (isAdultAnimal()) {
        pregnancySection.classList.remove('hidden');
      } else {
        pregnancySection.classList.add('hidden');
        if (pregnancyCheckbox) {
          pregnancyCheckbox.checked = false;
        }
        if (pregnancyDetails) {
          pregnancyDetails.classList.add('hidden');
        }
      }
    }

    if (animalTypeSelect) animalTypeSelect.addEventListener('change', updatePregnancySection);
    if (ageValueInput) ageValueInput.addEventListener('input', updatePregnancySection);
    if (ageUnitSelect) ageUnitSelect.addEventListener('change', updatePregnancySection);
    if (genderSelect) genderSelect.addEventListener('change', updatePregnancySection);
    if (dateOfBirthInput) dateOfBirthInput.addEventListener('change', calculateAgeFromDOB);

    if (pregnancyCheckbox && pregnancyDetails) {
      pregnancyCheckbox.addEventListener('change', function() {
        if (this.checked) {
          pregnancyDetails.classList.remove('hidden');
        } else {
          pregnancyDetails.classList.add('hidden');
        }
      });
    }

    updatePregnancySection();
  }

  // ================ VACCINE FUNCTIONS ================
  
  function initializeVaccineCheckboxes(animalIndex) {
    const vaccineCheckboxes = document.querySelectorAll(`.animal-vaccine-checkbox[data-animal-index="${animalIndex}"]`);
    
    vaccineCheckboxes.forEach(checkbox => {
      const vaccineId = checkbox.dataset.vaccineId;
      const detailsDiv = document.getElementById(`vaccineDetails_${animalIndex}_${vaccineId}`);
      
      checkbox.addEventListener('change', function() {
        if (this.checked && detailsDiv) {
          detailsDiv.classList.remove('hidden');
          
          // Auto-set dates if common vaccination is enabled
          if (commonVaccinationEnabled) {
            const commonDate = document.getElementById('commonVaccinationDate').value;
            const commonNextDue = document.getElementById('commonNextDueDate').value;
            const commonAdministeredBy = document.getElementById('commonAdministeredBy').value;
            
            const dateInput = detailsDiv.querySelector('.vaccination-date');
           // const nextDueInput = detailsDiv.querySelector('.next-due-date');
            const administeredByInput = detailsDiv.querySelector('input[name*="[administeredBy]"]');
            
            if (dateInput && commonDate) dateInput.value = commonDate;
           // if (nextDueInput && commonNextDue) nextDueInput.value = commonNextDue;
            if (administeredByInput && commonAdministeredBy) administeredByInput.value = commonAdministeredBy;
          } else {
            // Set default dates if not already set
            const dateInput = detailsDiv.querySelector('.vaccination-date');
            if (dateInput && !dateInput.value) {
              dateInput.value = new Date().toISOString().split('T')[0];
            }
            
            //const nextDueInput = detailsDiv.querySelector('.next-due-date');
           // if (nextDueInput && !nextDueInput.value) {
           //   const nextDate = new Date();
           //   nextDate.setFullYear(nextDate.getFullYear() + 1);
          //    nextDueInput.value = nextDate.toISOString().split('T')[0];
          //  }
          }
        } else if (detailsDiv) {
          detailsDiv.classList.add('hidden');
        }
      });
      
      if (checkbox.checked && detailsDiv) {
        detailsDiv.classList.remove('hidden');
      }
    });
  }

  // ================ COMMON FOR ALL ANIMALS CHECKBOX ================
  
  function initializeCommonForAllCheckboxes() {
    document.querySelectorAll('.common-vaccination-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        const animalIndex = this.dataset.animalIndex;
        const isChecked = this.checked;
        
        if (isChecked) {
          // Apply this animal's vaccinations to all other animals
          const sourceVaccineCheckboxes = document.querySelectorAll(`.animal-vaccine-checkbox[data-animal-index="${animalIndex}"]:checked`);
          
          // Get all other animal entries
          const animalEntries = document.querySelectorAll('.animal-entry');
          
          for (let i = 0; i < animalEntries.length; i++) {
            if (i != animalIndex) {
              sourceVaccineCheckboxes.forEach(sourceCheckbox => {
                const vaccineId = sourceCheckbox.dataset.vaccineId;
                const targetCheckbox = document.querySelector(`.animal-vaccine-checkbox[data-animal-index="${i}"][data-vaccine-id="${vaccineId}"]`);
                
                if (targetCheckbox) {
                  targetCheckbox.checked = sourceCheckbox.checked;
                  targetCheckbox.dispatchEvent(new Event('change'));
                  
                  // Copy vaccination details
                  if (sourceCheckbox.checked) {
                    const sourceDetails = document.getElementById(`vaccineDetails_${animalIndex}_${vaccineId}`);
                    const targetDetails = document.getElementById(`vaccineDetails_${i}_${vaccineId}`);
                    
                    if (sourceDetails && targetDetails) {
                      copyVaccinationDetails(sourceDetails, targetDetails);
                    }
                  }
                }
              });
            }
          }
          
          alert(`Vaccination records from Animal ${parseInt(animalIndex) + 1} applied to all other animals.`);
        }
      });
    });
  }

  function copyVaccinationDetails(source, target) {
    // Copy date
    const sourceDate = source.querySelector('.vaccination-date');
    const targetDate = target.querySelector('.vaccination-date');
    if (sourceDate && targetDate) targetDate.value = sourceDate.value;
    
    // Copy next due date
    const sourceNextDue = source.querySelector('.next-due-date');
    const targetNextDue = target.querySelector('.next-due-date');
    if (sourceNextDue && targetNextDue) targetNextDue.value = sourceNextDue.value;
    
    // Copy administered by
    const sourceAdministeredBy = source.querySelector('input[name*="[administeredBy]"]');
    const targetAdministeredBy = target.querySelector('input[name*="[administeredBy]"]');
    if (sourceAdministeredBy && targetAdministeredBy) targetAdministeredBy.value = sourceAdministeredBy.value;
    
    // Copy batch number
    const sourceBatch = source.querySelector('input[name*="[batchNumber]"]');
    const targetBatch = target.querySelector('input[name*="[batchNumber]"]');
    if (sourceBatch && targetBatch) targetBatch.value = sourceBatch.value;
    
    // Copy notes
    const sourceNotes = source.querySelector('textarea');
    const targetNotes = target.querySelector('textarea');
    if (sourceNotes && targetNotes) targetNotes.value = sourceNotes.value;
  }

  // ================ COMMON VACCINATION DATE ================
  
  function initializeCommonVaccinationDate() {
    const applyCommonCheckbox = document.getElementById('applyCommonVaccinationDate');
    const commonDateSection = document.getElementById('commonVaccinationDateSection');
    
    if (applyCommonCheckbox && commonDateSection) {
      applyCommonCheckbox.addEventListener('change', function() {
        commonVaccinationEnabled = this.checked;
        
        if (this.checked) {
          commonDateSection.classList.remove('hidden');
        } else {
          commonDateSection.classList.add('hidden');
        }
      });
      
      // When common dates are set, apply to all checked vaccines
      const commonDate = document.getElementById('commonVaccinationDate');
      const commonNextDue = document.getElementById('commonNextDueDate');
      const commonAdministeredBy = document.getElementById('commonAdministeredBy');
      
      [commonDate, commonNextDue, commonAdministeredBy].forEach(input => {
        if (input) {
          input.addEventListener('change', function() {
            if (commonVaccinationEnabled) {
              applyCommonDatesToAllCheckedVaccines();
            }
          });
        }
      });
    }
  }

  function applyCommonDatesToAllCheckedVaccines() {
    const commonDate = document.getElementById('commonVaccinationDate').value;
    const commonNextDue = document.getElementById('commonNextDueDate').value;
    const commonAdministeredBy = document.getElementById('commonAdministeredBy').value;
    
    if (!commonDate && !commonNextDue && !commonAdministeredBy) return;
    
    document.querySelectorAll('.animal-vaccine-checkbox:checked').forEach(checkbox => {
      const animalIndex = checkbox.dataset.animalIndex;
      const vaccineId = checkbox.dataset.vaccineId;
      const detailsDiv = document.getElementById(`vaccineDetails_${animalIndex}_${vaccineId}`);
      
      if (detailsDiv) {
        const dateInput = detailsDiv.querySelector('.vaccination-date');
        const nextDueInput = detailsDiv.querySelector('.next-due-date');
        const administeredByInput = detailsDiv.querySelector('input[name*="[administeredBy]"]');
        
        if (dateInput && commonDate) dateInput.value = commonDate;
        if (nextDueInput && commonNextDue) nextDueInput.value = commonNextDue;
        if (administeredByInput && commonAdministeredBy) administeredByInput.value = commonAdministeredBy;
      }
    });
  }

  // ================ ADD ANOTHER ANIMAL ================
  
  document.getElementById('addAnimalBtn')?.addEventListener('click', function() {
    if (animalCount >= maxAnimals) {
      alert(`Maximum ${maxAnimals} animals can be registered at once.`);
      return;
    }

    const template = document.querySelector('.animal-entry').cloneNode(true);
    const newIndex = animalCount;

    // Update all IDs and names
    template.querySelectorAll('[id]').forEach(el => {
      if (el.id) {
        el.id = el.id.replace(/\d+/, newIndex);
      }
    });

    template.querySelectorAll('[name]').forEach(el => {
      if (el.name && el.name.includes('[0]')) {
        el.name = el.name.replace('[0]', `[${newIndex}]`);
      }
      if (el.name && el.name.includes('[0]')) {
        el.name = el.name.replace('[0]', `[${newIndex}]`);
      }
    });

    // Update labels for attribute
    template.querySelectorAll('[for]').forEach(el => {
      if (el.htmlFor) {
        el.htmlFor = el.htmlFor.replace(/\d+/, newIndex);
      }
    });

    // Update data attributes
    template.querySelectorAll('[data-animal-index]').forEach(el => {
      el.dataset.animalIndex = newIndex;
    });

    // Update heading
    const heading = template.querySelector('h2');
    if (heading) heading.textContent = `Animal ${newIndex + 1} Details`;

    // Update vaccination section heading
    const vaccHeading = template.querySelector('h3.flex.items-center');
    if (vaccHeading) {
      vaccHeading.innerHTML = vaccHeading.innerHTML.replace(/Animal \d+/, `Animal ${newIndex + 1}`);
    }

    // Clear input values
    template.querySelectorAll('input[type="text"], input[type="number"], input[type="date"], textarea').forEach(el => {
      el.value = '';
    });

    // Reset selects to first option
    template.querySelectorAll('select').forEach(el => {
      if (el.name && (el.name.includes('animalType') || el.name.includes('gender') || el.name.includes('healthStatus'))) {
        el.selectedIndex = 0;
      }
    });

    // Reset checkboxes
    template.querySelectorAll('input[type="checkbox"]').forEach(el => {
      el.checked = false;
    });

    // Hide pregnancy section and details
    const pregnancySection = template.querySelector('.pregnancy-section');
    if (pregnancySection) {
      pregnancySection.classList.add('hidden');
    }
    
    const pregnancyDetails = template.querySelector('.pregnancy-details');
    if (pregnancyDetails) {
      pregnancyDetails.classList.add('hidden');
    }

    // Hide all vaccine details
    template.querySelectorAll('.vaccine-details').forEach(el => {
      el.classList.add('hidden');
    });

    // Add remove button
    const header = template.querySelector('.flex.justify-between');
    if (header) {
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'bg-red-100 hover:bg-red-200 text-red-700 dark:bg-red-900 dark:hover:bg-red-800 dark:text-red-300 text-sm font-medium py-1 px-3 rounded-lg transition flex items-center';
      removeBtn.innerHTML = `
        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
        </svg>
        Remove
      `;
      removeBtn.addEventListener('click', function() {
        template.remove();
        animalCount--;
        updateAnimalCount();
      });
      header.appendChild(removeBtn);
    }

    // Add before the add button
    document.getElementById('addAnimalBtn').parentElement.before(template);
    animalCount++;
    updateAnimalCount();

    // Reinitialize event listeners for the new entry
    initializeAnimalEntry(template, newIndex);
    initializeVaccineCheckboxes(newIndex);
    initializeIsTaggedCheckbox(newIndex);
    initializeVaccinationDateListeners(template);
  });

  // ================ DATE OF BIRTH FUNCTIONS ================
  
  function initializeDateOfBirthCalculation() {
    document.querySelectorAll('.date-of-birth').forEach((dobInput, index) => {
      const entry = dobInput.closest('.animal-entry');
      if (entry) {
        dobInput.addEventListener('change', function() {
          calculateAgeFromDOBForEntry(entry);
        });
      }
    });
  }

  function calculateAgeFromDOBForEntry(entry) {
    const dobInput = entry.querySelector('.date-of-birth');
    const ageValueInput = entry.querySelector('.age-value-input');
    const ageUnitSelect = entry.querySelector('.age-unit-select');
    
    if (!dobInput || !dobInput.value || !ageValueInput || !ageUnitSelect) return;
    
    const dob = new Date(dobInput.value);
    const today = new Date();
    
    let years = today.getFullYear() - dob.getFullYear();
    let months = today.getMonth() - dob.getMonth();
    let days = today.getDate() - dob.getDate();
    
    if (days < 0) {
      months--;
      days += new Date(today.getFullYear(), today.getMonth(), 0).getDate();
    }
    
    if (months < 0) {
      years--;
      months += 12;
    }
    
    if (years >= 1) {
      ageValueInput.value = years;
      ageUnitSelect.value = 'Years';
    } else if (months >= 1) {
      ageValueInput.value = months;
      ageUnitSelect.value = 'Months';
    } else {
      ageValueInput.value = days;
      ageUnitSelect.value = 'Days';
    }
    
    ageValueInput.dispatchEvent(new Event('input'));
  }

  // ================ FORM VALIDATION ================
  
  function initializeFormValidation() {
    const form = document.querySelector('form');
    if (!form) return;
    
    form.addEventListener('submit', function(e) {
      // Debug: Log all form data
      const formData = new FormData(form);
      console.log('========== FORM SUBMISSION DEBUG ==========');
      console.log('All form entries:');
      for (let [key, value] of formData.entries()) {
        if (key.includes('vaccinations')) {
          console.log(`  ${key}: ${value}`);
        }
      }
      
      // Check all checked vaccines
      const checkedVaccines = document.querySelectorAll('.animal-vaccine-checkbox:checked');
      console.log('Checked vaccines count:', checkedVaccines.length);
      checkedVaccines.forEach((checkbox, index) => {
        console.log(`Vaccine ${index}:`, {
          animalIndex: checkbox.dataset.animalIndex,
          vaccineId: checkbox.dataset.vaccineId,
          name: checkbox.name,
          value: checkbox.value
        });
      });
      console.log('==========================================');

      // Check if farmer is selected
      const farmerSelect = document.getElementById('farmer');
      if (!farmerSelect.value) {
        e.preventDefault();
        alert('Please select a farmer.');
        farmerSelect.focus();
        return;
      }

      // Check if registeredBy is selected
      const registeredBySelect = document.getElementById('registeredBy');
      if (!registeredBySelect.value) {
        e.preventDefault();
        alert('Please select who is registering the animals.');
        registeredBySelect.focus();
        return;
      }

      // Validate each animal entry
      const animalEntries = document.querySelectorAll('.animal-entry');
      for (let i = 0; i < animalEntries.length; i++) {
        const entry = animalEntries[i];
        
        const animalType = entry.querySelector('.animal-type-select');
        const gender = entry.querySelector('.gender-select');
        const tagNumber = entry.querySelector('input[name*="tagNumber"]');
        const isTaggedCheckbox = entry.querySelector('input[name*="isTagged"]');
        const healthStatus = entry.querySelector('select[name*="healthStatus"]');

        if (!animalType.value) {
          e.preventDefault();
          alert(`Please select animal type for Animal ${i + 1}.`);
          animalType.focus();
          return;
        }

        if (!gender.value) {
          e.preventDefault();
          alert(`Please select gender for Animal ${i + 1}.`);
          gender.focus();
          return;
        }

        // Only require tagNumber if isTagged checkbox is checked
        if (isTaggedCheckbox && isTaggedCheckbox.checked) {
          if (!tagNumber || !tagNumber.value.trim()) {
            e.preventDefault();
            alert(`Please enter tag number for Animal ${i + 1}.`);
            if (tagNumber) tagNumber.focus();
            return;
          }
        }

        if (!healthStatus.value) {
          e.preventDefault();
          alert(`Please select health status for Animal ${i + 1}.`);
          healthStatus.focus();
          return;
        }
      }

      // Validate vaccines that are checked
      if (checkedVaccines.length > 0) {
        for (let i = 0; i < checkedVaccines.length; i++) {
          const checkbox = checkedVaccines[i];
          const animalIndex = checkbox.dataset.animalIndex;
          const vaccineId = checkbox.dataset.vaccineId;
          const detailsDiv = document.getElementById(`vaccineDetails_${animalIndex}_${vaccineId}`);
          
          if (detailsDiv) {
            const dateInput = detailsDiv.querySelector('.vaccination-date');
            const administeredByInput = detailsDiv.querySelector('input[name*="[administeredBy]"]');
            
            if (!dateInput || !dateInput.value) {
              e.preventDefault();
              alert(`Please enter vaccination date for the selected vaccine in Animal ${parseInt(animalIndex) + 1}.`);
              dateInput?.focus();
              return;
            }
            
            if (!administeredByInput || !administeredByInput.value.trim()) {
              e.preventDefault();
              alert(`Please enter who administered the vaccine for Animal ${parseInt(animalIndex) + 1}.`);
              administeredByInput?.focus();
              return;
            }
          }
        }
      }

      // Show loading state
      const submitBtn = form.querySelector('button[type="submit"]');
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="flex items-center justify-center"><svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Processing...</span>';
      }
    });
  }

  // ================ UTILITY FUNCTIONS ================
  
  function updateAnimalCount() {
    const countElement = document.getElementById('animalCount');
    if (countElement) {
      countElement.textContent = animalCount;
    }
  }
</script>

<style>
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
  
  .animate-spin {
    animation: spin 1s linear infinite;
  }
  
  .vaccine-details,
  .pregnancy-details,
  .pregnancy-section {
    transition: all 0.3s ease-in-out;
  }
  
  input[type="file"]::file-selector-button {
    transition: background-color 0.2s ease;
  }
  
  .common-vaccination-checkbox:checked + label {
    color: #059669;
  }
</style>

<!-- Add this JavaScript at the bottom of your form or in a separate script tag -->
<script>
// Function to calculate next due date based on vaccination date and booster interval
function calculateNextDueDate(input) {
    const vaccinationDate = input.value;
    const boosterWeeks = parseInt(input.dataset.boosterWeeks || 0);
    const animalIndex = input.dataset.animalIndex;
    const vaccineId = input.dataset.vaccineId;
    
    if (vaccinationDate && boosterWeeks > 0) {
        // Create date from vaccination date
        const date = new Date(vaccinationDate);
        
        // Add booster interval (weeks) to the date
        date.setDate(date.getDate() + (boosterWeeks * 7));
        
        // Format as YYYY-MM-DD
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const nextDueDate = `${year}-${month}-${day}`;
        
        // Find the corresponding next due date input using name attribute (more reliable)
        const nextDueInput = document.querySelector(`input[name="animals[${animalIndex}][vaccinations][${vaccineId}][nextDueDate]"]`);
        if (nextDueInput) {
            nextDueInput.value = nextDueDate;
        }
    }
}

// Alternative function - finds animal index dynamically from button context
function autoCalculateNextDue(button) {
    // Find the parent vaccine details container
    const vaccinationSection = button.closest('[class*="vaccine-details"]') || button.closest('.grid');
    if (!vaccinationSection) return;
    
    // Get the vaccination date input
    const vaccineDateInput = vaccinationSection.querySelector('.vaccination-date');
    if (!vaccineDateInput || !vaccineDateInput.value) {
        alert('Please select a vaccination date first.');
        return;
    }
    
    const boosterWeeks = parseInt(vaccineDateInput.dataset.boosterWeeks || 0);
    
    if (boosterWeeks > 0) {
        // Create date from vaccination date
        const date = new Date(vaccineDateInput.value);
        
        // Add booster interval (weeks) to the date
        date.setDate(date.getDate() + (boosterWeeks * 7));
        
        // Format as YYYY-MM-DD
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const nextDueDate = `${year}-${month}-${day}`;
        
        // Find the next due date input in the same container
        const nextDueInput = vaccinationSection.querySelector('.next-due-date');
        if (nextDueInput) {
            nextDueInput.value = nextDueDate;
            
            // Highlight the field briefly to show it was updated
            nextDueInput.classList.add('bg-green-100', 'dark:bg-green-900/30');
            setTimeout(() => {
                nextDueInput.classList.remove('bg-green-100', 'dark:bg-green-900/30');
            }, 1000);
        }
    }
}


</script>